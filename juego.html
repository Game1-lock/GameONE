<!DOCTYPE html>
<html>
<head>
    <title>Juego Flechitas - WebRTC</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="firebase-config.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial;
        }
        #game-container {
            width: 100%;
            max-width: 450px;
            background: #34495e;
            border-radius: 30px;
            padding: 15px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.5);
        }
        #header {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 1.3rem;
            margin-bottom: 15px;
            background: #2c3e50;
            padding: 15px;
            border-radius: 50px;
            font-weight: bold;
        }
        #campo {
            position: relative;
            width: 100%;
            height: 500px;
            background: #27ae60;
            border-radius: 30px;
            overflow: hidden;
            border: 4px solid #f39c12;
            margin-bottom: 15px;
        }
        #campo::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.5);
            transform: translateY(-50%);
            z-index: 5;
        }
        #mi-zona {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: rgba(46, 204, 113, 0.2);
            z-index: 1;
        }
        #rival-zona {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: rgba(231, 76, 60, 0.2);
            z-index: 1;
        }
        #mi-jugador {
            position: absolute;
            bottom: 20px;
            width: 50px;
            height: 70px;
            background: #f1c40f;
            border-radius: 25px 25px 10px 10px;
            transform: translateX(-50%);
            transition: left 0.05s;
            z-index: 20;
            border: 3px solid white;
        }
        #rival-marcador {
            position: absolute;
            top: 20px;
            width: 40px;
            height: 40px;
            background: #e74c3c;
            border-radius: 50%;
            transform: translateX(-50%);
            z-index: 20;
            border: 3px solid white;
            opacity: 0.7;
        }
        .flecha {
            position: absolute;
            width: 8px;
            height: 25px;
            background: #f39c12;
            border-radius: 4px;
            z-index: 15;
        }
        .flecha-enemiga {
            background: #c0392b;
        }
        .obstaculo {
            position: absolute;
            width: 45px;
            height: 45px;
            background: #7f8c8d;
            border-radius: 10px;
            border: 3px solid #95a5a6;
            z-index: 10;
            opacity: 0.9;
        }
        #controles {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .control-btn {
            flex: 1;
            padding: 20px;
            font-size: 1.8rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 5px 0 #2980b9;
            touch-action: manipulation;
        }
        .control-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }
        #info-flechas {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2c3e50;
            padding: 15px;
            border-radius: 50px;
            color: white;
            font-size: 1.3rem;
            margin-top: 10px;
        }
        #cargas-flechas {
            display: flex;
            gap: 8px;
        }
        .carga {
            width: 30px;
            height: 30px;
            background: #f39c12;
            border-radius: 50%;
            border: 2px solid white;
        }
        .carga-vacia {
            background: #7f8c8d;
            opacity: 0.5;
        }
        #vidas {
            color: #e74c3c;
            font-weight: bold;
        }
        #mensaje {
            text-align: center;
            color: white;
            margin: 15px 0;
            font-size: 1.3rem;
            min-height: 30px;
        }
        #estado-conexion {
            text-align: center;
            color: #f39c12;
            font-size: 1rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <span>üèπ YO: <span id="mis-vidas">5</span></span>
            <span>‚öîÔ∏è VS ‚öîÔ∏è</span>
            <span>üéØ RIVAL: <span id="rival-vidas">5</span></span>
        </div>
        
        <div id="campo">
            <div id="mi-zona"></div>
            <div id="rival-zona"></div>
            <div id="mi-jugador"></div>
            <div id="rival-marcador"></div>
        </div>
        
        <div id="controles">
            <button class="control-btn" id="btnIzq">‚¨ÖÔ∏è</button>
            <button class="control-btn" id="btnDisparar">üèπ</button>
            <button class="control-btn" id="btnDer">‚û°Ô∏è</button>
        </div>
        
        <div id="info-flechas">
            <span>FLECHAS:</span>
            <div id="cargas-flechas">
                <div class="carga"></div>
                <div class="carga"></div>
                <div class="carga"></div>
                <div class="carga"></div>
                <div class="carga"></div>
            </div>
        </div>
        
        <div id="mensaje"></div>
        <div id="estado-conexion">üîå Conectando...</div>
    </div>

    <script>
        // ========== CONFIGURACI√ìN ==========
        const urlParams = new URLSearchParams(window.location.search);
        const partidaId = urlParams.get('partida');
        let usuarioActual = null;
        let miId = null;
        let rivalId = null;
        let partidaRef = null;
        
        // Estado del juego
        let juegoActivo = true;
        let misVidas = 5;
        let rivalVidas = 5;
        let miPosicion = 50;
        
        // Flechas
        let flechasDisponibles = 5;
        const MAX_FLECHAS = 5;
        const TIEMPO_RECARGA = 3000;
        
        // WebRTC
        let peer = null;
        let conn = null;
        let miPeerId = null;
        
        // ========== INICIALIZACI√ìN ==========
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user;
                miId = user.uid;
                iniciarJuego();
            } else {
                window.location.href = 'login.html';
            }
        });

        function iniciarJuego() {
            partidaRef = firebase.database().ref('partidas/' + partidaId);
            
            partidaRef.once('value', (snapshot) => {
                const partida = snapshot.val();
                if (partida.j1 === miId) {
                    rivalId = partida.j2;
                } else {
                    rivalId = partida.j1;
                }
                
                misVidas = partida.vidas[miId] || 5;
                rivalVidas = partida.vidas[rivalId] || 5;
                actualizarVidas();
                
                // Iniciar WebRTC
                iniciarWebRTC();
                
                // Iniciar sistemas
                iniciarRecarga();
                iniciarObstaculos();
            });
        }

        // ========== WEBRTC ==========
        function iniciarWebRTC() {
            document.getElementById('estado-conexion').innerHTML = "üîå Iniciando WebRTC...";
            
            // Crear peer con servidores STUN gratis
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                miPeerId = id;
                document.getElementById('estado-conexion').innerHTML = "üì° Conectando con rival...";
                
                // Guardar mi Peer ID en Firebase
                partidaRef.child('webrtc/' + miId).set(id);
                
                // Esperar Peer ID del rival
                partidaRef.child('webrtc/' + rivalId).on('value', (snapshot) => {
                    const rivalPeerId = snapshot.val();
                    if (rivalPeerId && !conn) {
                        // Conectar con el rival
                        conn = peer.connect(rivalPeerId);
                        
                        conn.on('open', () => {
                            document.getElementById('estado-conexion').innerHTML = "‚úÖ Conexi√≥n directa!";
                            
                            // Enviar mi posici√≥n inicial
                            conn.send({
                                tipo: 'movimiento',
                                posicion: miPosicion
                            });
                        });
                        
                        conn.on('data', recibirDatosWebRTC);
                        
                        conn.on('error', (err) => {
                            document.getElementById('estado-conexion').innerHTML = "‚ö†Ô∏è Error en conexi√≥n";
                        });
                    }
                });
            });
            
            peer.on('connection', (incomingConn) => {
                conn = incomingConn;
                document.getElementById('estado-conexion').innerHTML = "‚úÖ Conexi√≥n directa!";
                
                conn.on('data', recibirDatosWebRTC);
                
                // Enviar mi posici√≥n
                conn.send({
                    tipo: 'movimiento',
                    posicion: miPosicion
                });
            });
            
            peer.on('error', (err) => {
                document.getElementById('estado-conexion').innerHTML = "‚ùå Error WebRTC, usando Firebase";
                // Fallback a Firebase si WebRTC falla
                usarFirebaseFallback();
            });
        }

        function recibirDatosWebRTC(data) {
            if (!juegoActivo) return;
            
            switch(data.tipo) {
                case 'movimiento':
                    document.getElementById('rival-marcador').style.left = data.posicion + '%';
                    break;
                    
                case 'disparo':
                    crearFlechaEnemiga(data.posicion, data.id);
                    break;
                    
                case 'danio':
                    if (data.recibe === miId) {
                        misVidas = Math.max(0, misVidas - 1);
                        actualizarVidas();
                        if (misVidas <= 0) finDelJuego('üíÄ PERDISTE üíÄ');
                    }
                    break;
            }
        }

        // ========== MOVIMIENTO ==========
        document.getElementById('btnIzq').addEventListener('click', moverIzq);
        document.getElementById('btnIzq').addEventListener('touchstart', (e) => {
            e.preventDefault();
            moverIzq();
        });

        document.getElementById('btnDer').addEventListener('click', moverDer);
        document.getElementById('btnDer').addEventListener('touchstart', (e) => {
            e.preventDefault();
            moverDer();
        });

        function moverIzq() {
            if (!juegoActivo) return;
            miPosicion = Math.max(5, miPosicion - 5);
            actualizarPosicion();
        }

        function moverDer() {
            if (!juegoActivo) return;
            miPosicion = Math.min(95, miPosicion + 5);
            actualizarPosicion();
        }

        function actualizarPosicion() {
            document.getElementById('mi-jugador').style.left = miPosicion + '%';
            
            // Enviar por WebRTC
            if (conn && conn.open) {
                conn.send({
                    tipo: 'movimiento',
                    posicion: miPosicion
                });
            }
        }

        // ========== DISPAROS ==========
        document.getElementById('btnDisparar').addEventListener('click', disparar);
        document.getElementById('btnDisparar').addEventListener('touchstart', (e) => {
            e.preventDefault();
            disparar();
        });

        function disparar() {
            if (!juegoActivo) return;
            if (flechasDisponibles <= 0) {
                mostrarMensaje("‚è≥ Sin flechas!", 1000);
                return;
            }
            
            flechasDisponibles--;
            actualizarInterfazFlechas();
            
            const flechaId = Date.now() + '-' + Math.random();
            
            // Crear flecha visual
            crearFlechaPropia(miPosicion, flechaId);
            
            // Enviar por WebRTC
            if (conn && conn.open) {
                conn.send({
                    tipo: 'disparo',
                    posicion: miPosicion,
                    id: flechaId
                });
            }
        }

        function crearFlechaPropia(posicion, id) {
            const flecha = document.createElement('div');
            flecha.className = 'flecha';
            flecha.id = 'flecha-' + id;
            flecha.style.left = posicion + '%';
            flecha.style.bottom = '100px';
            document.getElementById('campo').appendChild(flecha);
            
            let y = 100;
            const intervalo = setInterval(() => {
                y += 8;
                flecha.style.bottom = y + 'px';
                
                // Si llega a zona rival
                if (y > 250 && y < 300) {
                    // Notificar posible da√±o (simplificado)
                    if (conn && conn.open) {
                        conn.send({
                            tipo: 'danio',
                            recibe: rivalId
                        });
                    }
                }
                
                if (y > 500) {
                    clearInterval(intervalo);
                    flecha.remove();
                }
            }, 30);
        }

        function crearFlechaEnemiga(posicion, id) {
            const flecha = document.createElement('div');
            flecha.className = 'flecha flecha-enemiga';
            flecha.id = 'flecha-enemiga-' + id;
            flecha.style.left = posicion + '%';
            flecha.style.top = '20px';
            document.getElementById('campo').appendChild(flecha);
            
            let y = 20;
            const intervalo = setInterval(() => {
                y += 8;
                flecha.style.top = y + 'px';
                
                // Verificar colisi√≥n con mi jugador
                if (juegoActivo) {
                    const rectFlecha = flecha.getBoundingClientRect();
                    const rectJugador = document.getElementById('mi-jugador').getBoundingClientRect();
                    
                    if (rectFlecha.left < rectJugador.right && 
                        rectFlecha.right > rectJugador.left &&
                        rectFlecha.top < rectJugador.bottom &&
                        rectFlecha.bottom > rectJugador.top) {
                        
                        clearInterval(intervalo);
                        flecha.remove();
                        misVidas--;
                        actualizarVidas();
                        if (misVidas <= 0) finDelJuego('üíÄ PERDISTE üíÄ');
                    }
                }
                
                if (y > 500) {
                    clearInterval(intervalo);
                    flecha.remove();
                }
            }, 30);
        }

        // ========== RECARGA ==========
        function iniciarRecarga() {
            setInterval(() => {
                if (juegoActivo && flechasDisponibles < MAX_FLECHAS) {
                    flechasDisponibles++;
                    actualizarInterfazFlechas();
                }
            }, TIEMPO_RECARGA);
        }

        function actualizarInterfazFlechas() {
            const cargas = document.querySelectorAll('.carga');
            cargas.forEach((carga, index) => {
                if (index < flechasDisponibles) {
                    carga.classList.remove('carga-vacia');
                } else {
                    carga.classList.add('carga-vacia');
                }
            });
        }

        // ========== OBST√ÅCULOS ==========
        let obstaculos = [];
        const MAX_OBSTACULOS = 5;

        function iniciarObstaculos() {
            setInterval(() => {
                if (!juegoActivo) return;
                
                obstaculos = obstaculos.filter(obs => {
                    if (Date.now() - obs.tiempo > 5000) {
                        document.getElementById(obs.id)?.remove();
                        return false;
                    }
                    return true;
                });
                
                if (obstaculos.length < MAX_OBSTACULOS) {
                    crearObstaculo();
                }
            }, 2000);
        }

        function crearObstaculo() {
            const id = 'obs-' + Date.now() + '-' + Math.random();
            const x = 10 + Math.random() * 80;
            const y = 20 + Math.random() * 60;
            
            const obstaculo = document.createElement('div');
            obstaculo.className = 'obstaculo';
            obstaculo.id = id;
            obstaculo.style.left = x + '%';
            obstaculo.style.top = y + '%';
            document.getElementById('campo').appendChild(obstaculo);
            
            obstaculos.push({
                id: id,
                x: x,
                y: y,
                tiempo: Date.now()
            });
        }

        // ========== FALLBACK ==========
        function usarFirebaseFallback() {
            // Escuchar movimientos por Firebase si WebRTC falla
            partidaRef.child('posicion').on('value', (snapshot) => {
                const pos = snapshot.val();
                if (pos && pos.jugador === rivalId) {
                    document.getElementById('rival-marcador').style.left = pos.posicion + '%';
                }
            });
            
            partidaRef.child('disparos').on('child_added', (snapshot) => {
                const disparo = snapshot.val();
                if (disparo.jugador === rivalId) {
                    crearFlechaEnemiga(disparo.posicion, disparo.id);
                }
            });
        }

        // ========== UTILIDADES ==========
        function actualizarVidas() {
            document.getElementById('mis-vidas').textContent = misVidas;
            document.getElementById('rival-vidas').textContent = rivalVidas;
        }

        function mostrarMensaje(texto, tiempo) {
            document.getElementById('mensaje').textContent = texto;
            setTimeout(() => {
                document.getElementById('mensaje').textContent = '';
            }, tiempo);
        }

        function finDelJuego(mensaje) {
            juegoActivo = false;
            document.getElementById('mensaje').textContent = mensaje;
            setTimeout(() => {
                window.location.href = 'lobby.html';
            }, 3000);
        }

        // Inicializar posici√≥n
        window.onload = () => {
            document.getElementById('mi-jugador').style.left = '50%';
            document.getElementById('rival-marcador').style.left = '50%';
            actualizarInterfazFlechas();
        };
    </script>
</body>
</html>
