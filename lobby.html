<!DOCTYPE html>
<html>
<head>
    <title>Lobby - Buscar partida</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        #usuario-info {
            font-size: 1.2rem;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 50px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 400px;
        }
        #btnBuscar {
            width: 100%;
            max-width: 400px;
            padding: 30px 20px;
            font-size: 2.5rem;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 60px;
            margin: 20px 0;
            font-weight: bold;
            border: 4px solid white;
            box-shadow: 0 15px 25px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.1s;
        }
        #btnBuscar:active {
            transform: scale(0.95);
            background: #e67e22;
        }
        #btnBuscar:disabled {
            background: #95a5a6;
            transform: none;
        }
        #estado {
            margin-top: 30px;
            font-size: 1.8rem;
            min-height: 80px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 50px;
            width: 100%;
            max-width: 400px;
        }
        .logout {
            margin-top: 20px;
            color: #ecf0f1;
            text-decoration: none;
            font-size: 1.2rem;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>üèπ LOBBY</h1>
    <div id="usuario-info">Cargando...</div>
    
    <button id="btnBuscar">üîç BUSCAR PARTIDA</button>
    
    <div id="estado">Esperando...</div>
    
    <a href="#" class="logout" id="logout">Cerrar sesi√≥n</a>

    <script>
        let usuarioActual = null;
        let buscandoPartida = false;
        let listenerPartida = null;
        let listenerEspera = null;
        let miReferenciaEspera = null;

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user;
                document.getElementById('usuario-info').innerHTML = 
                    `üë§ ${user.email}<br><small>ID: ${user.uid.substring(0,8)}</small>`;
            } else {
                window.location.href = 'login.html';
            }
        });

        document.getElementById('btnBuscar').addEventListener('click', buscarPartida);
        document.getElementById('btnBuscar').addEventListener('touchstart', (e) => {
            e.preventDefault();
            buscarPartida();
        });

        function buscarPartida() {
            if (buscandoPartida || !usuarioActual) return;
            
            buscandoPartida = true;
            document.getElementById('btnBuscar').disabled = true;
            document.getElementById('estado').innerHTML = "üîç Buscando oponente...";
            
            const waitingRef = firebase.database().ref('matchmaking/espera');
            
            // Verificar si ya hay alguien esperando
            waitingRef.once('value', (snapshot) => {
                const esperando = snapshot.val();
                
                if (esperando && esperando.jugadorId && esperando.jugadorId !== usuarioActual.uid) {
                    // Hay un oponente esperando, crear partida
                    crearPartida(esperando);
                } else {
                    // No hay nadie, nos ponemos en espera
                    ponerEnEspera();
                }
            });
        }

        function ponerEnEspera() {
            const waitingRef = firebase.database().ref('matchmaking/espera');
            
            // Guardar nuestra referencia para limpiarla despu√©s
            miReferenciaEspera = waitingRef;
            
            // Nos registramos en espera
            waitingRef.set({
                jugadorId: usuarioActual.uid,
                jugadorEmail: usuarioActual.email,
                timestamp: Date.now()
            });

            document.getElementById('estado').innerHTML = "‚è≥ Esperando oponente...";

            // Escuchar si alguien m√°s se une (crea una partida)
            listenerPartida = firebase.database().ref('matchmaking/partidas').limitToLast(1).on('child_added', (snapshot) => {
                const partida = snapshot.val();
                if (partida && (partida.jugador1 === usuarioActual.uid || partida.jugador2 === usuarioActual.uid)) {
                    // Esta partida nos incluye
                    document.getElementById('estado').innerHTML = "‚úÖ ¬°Partida encontrada!";
                    
                    // Limpiar todo
                    limpiarMatchmaking();
                    
                    setTimeout(() => {
                        window.location.href = `juego.html?partida=${snapshot.key}`;
                    }, 1500);
                }
            });
        }

        function crearPartida(oponente) {
            // Crear nueva partida
            const nuevaPartidaRef = firebase.database().ref('matchmaking/partidas').push();
            const partidaId = nuevaPartidaRef.key;
            
            nuevaPartidaRef.set({
                jugador1: usuarioActual.uid,
                email1: usuarioActual.email,
                jugador2: oponente.jugadorId,
                email2: oponente.jugadorEmail,
                estado: 'jugando',
                turno: usuarioActual.uid,
                inicio: Date.now(),
                vidas: {
                    [usuarioActual.uid]: 5,
                    [oponente.jugadorId]: 5
                }
            });

            // Limpiar la sala de espera (¬°esto es clave!)
            firebase.database().ref('matchmaking/espera').remove();
            
            document.getElementById('estado').innerHTML = "‚úÖ ¬°Oponente encontrado!";
            
            // Redirigir
            setTimeout(() => {
                window.location.href = `juego.html?partida=${partidaId}`;
            }, 1500);
        }

        function limpiarMatchmaking() {
            if (listenerPartida) {
                firebase.database().ref('matchmaking/partidas').off('child_added', listenerPartida);
            }
            // Limpiar nuestra entrada en espera si existe
            if (miReferenciaEspera) {
                miReferenciaEspera.remove();
            }
        }

        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            limpiarMatchmaking();
            firebase.auth().signOut().then(() => {
                window.location.href = 'login.html';
            });
        });

        window.addEventListener('beforeunload', () => {
            limpiarMatchmaking();
        });
    </script>
</body>
</html>
