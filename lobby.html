<!DOCTYPE html>
<html>
<head>
    <title>Lobby - Buscar partida</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            font-family: Arial;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #43cea2, #185a9d);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        button {
            width: 90%;
            max-width: 400px;
            padding: 30px;
            font-size: 2rem;
            background: #f39c12;
            border: none;
            border-radius: 60px;
            color: white;
            font-weight: bold;
            margin: 20px;
        }
        #estado {
            font-size: 1.5rem;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <h1>üèπ LOBBY</h1>
    <div id="usuario"></div>
    <button id="btnBuscar">üîç BUSCAR PARTIDA</button>
    <div id="estado">Esperando...</div>

    <script>
        let usuarioActual = null;
        const db = firebase.database();

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user;
                document.getElementById('usuario').innerHTML = `üë§ ${user.email}`;
            } else {
                window.location.href = 'login.html';
            }
        });

        document.getElementById('btnBuscar').onclick = buscarPartida;

        function buscarPartida() {
            document.getElementById('estado').innerHTML = "üîç Buscando...";
            
            // 1. Ver si hay alguien esperando
            db.ref('espera').once('value', (snapshot) => {
                let espera = snapshot.val();
                
                if (espera && espera !== usuarioActual.uid) {
                    // Hay alguien esperando, CREAR PARTIDA
                    let partidaId = Date.now() + ""; // ID √∫nico simple
                    
                    db.ref('partidas/' + partidaId).set({
                        j1: espera,
                        j2: usuarioActual.uid,
                        turno: espera,
                        vidas: { [espera]: 5, [usuarioActual.uid]: 5 }
                    });
                    
                    db.ref('espera').remove(); // Limpiar espera
                    
                    document.getElementById('estado').innerHTML = "‚úÖ Partida creada!";
                    window.location.href = 'juego.html?partida=' + partidaId;
                    
                } else {
                    // No hay nadie, me pongo en espera
                    db.ref('espera').set(usuarioActual.uid);
                    document.getElementById('estado').innerHTML = "‚è≥ Esperando oponente...";
                    
                    // Escuchar si alguien crea una partida conmigo
                    db.ref('partidas').on('child_added', (snap) => {
                        let p = snap.val();
                        if (p.j1 === usuarioActual.uid || p.j2 === usuarioActual.uid) {
                            document.getElementById('estado').innerHTML = "‚úÖ Encontrado!";
                            window.location.href = 'juego.html?partida=' + snap.key;
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
